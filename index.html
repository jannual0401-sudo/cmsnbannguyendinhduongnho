<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M√≥n Qu√† K·ª∑ Ni·ªám - Sinh Nh·∫≠t Vui V·∫ª</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&family=Quicksand:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* CSS kh√¥ng thay ƒë·ªïi nhi·ªÅu, ch·ªß y·∫øu th√™m c√°c style cho element m·ªõi */
        body { font-family: 'Quicksand', sans-serif; background-color: #FFF5EE; color: #4A4A4A; margin: 0; padding: 0; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; }
        .hidden { display: none !important; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.5s ease, visibility 0.5s ease; }
        .modal.show { opacity: 1; visibility: visible; }
        .modal-content { background: #FFFFFF; padding: 25px 30px; border-radius: 20px; text-align: center; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15); max-width: 90%; width: 400px; transform: scale(0.9); transition: transform 0.4s ease; }
        .modal.show .modal-content { transform: scale(1); }
        button { background: #FF69B4; color: white; border: none; padding: 12px 24px; border-radius: 10px; cursor: pointer; font-size: 16px; font-weight: bold; transition: background 0.3s ease, transform 0.2s ease; }
        button:hover { background: #FF1493; transform: translateY(-3px) scale(1.05); }
        #lock-screen { text-align: center; width: 100%; }
        .heart-lock { position: relative; width: 500px; height: 450px; margin: 0 auto; }
        .heart { fill: #FFC0CB; stroke: #FF69B4; stroke-width: 4; animation: pulse 1.5s infinite ease-in-out; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.03); } }
        .digits { position: absolute; top: 45%; left: 50%; transform: translate(-50%, -50%); display: flex; gap: 15px; }
        .digit-container { display: flex; flex-direction: column; align-items: center; }
        .digit { background: #FFFFFF; border: 2px solid #FF69B4; border-radius: 8px; width: 40px; height: 50px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 24px; margin: 5px 0; }
        .arrow-btn { background: transparent; color: #FF69B4; border: none; padding: 5px; font-size: 20px; cursor: pointer; }
        #hint { margin-top: 20px; font-size: 16px; color: #FF69B4; cursor: pointer; font-weight: bold; }
        #welcome { text-align: center; opacity: 0; transition: opacity 1s ease; width: 100%; }
        #welcome.show { opacity: 1; }
        .welcome-text { font-size: 2.5em; font-family: 'Pacifico', cursive; color: #FF69B4; text-shadow: 0 3px 6px rgba(0,0,0,0.1); animation: fadeIn-Up 1.5s ease-out forwards; }
        .welcome-text p { margin: 10px 0; font-family: 'Quicksand', sans-serif; font-size: 0.5em; font-weight: 500; color: #555; }
        @keyframes fadeIn-Up { 0% { opacity: 0; transform: translateY(40px); } 100% { opacity: 1; transform: translateY(0); } }
        #energy-bar { position: fixed; top: 20px; right: 20px; width: 150px; height: 15px; background: #ddd; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1); z-index: 999; }
        .bar { height: 100%; background: linear-gradient(to right, #76E071, #38A333); transition: width 1s ease, background-color 1s ease; }
        .bar.flashing { animation: flash 1s infinite; }
        @keyframes flash { 0%, 100% { background: #ff4d4d; } 50% { background: #ffb3b3; } }
        #avatar-container { position: fixed; top: 20px; left: 20px; z-index: 999; }
        #avatar { width: 50px; height: 50px; background-image: url('https://i.imgur.com/your-avatar.jpg'); background-size: cover; border-radius: 50%; cursor: pointer; border: 3px solid #FFC0CB; }
        .arrow-hint { position: absolute; top: 5px; left: 60px; background: white; padding: 5px 10px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); white-space: nowrap; }
        #announce { font-size: 2.5em; font-family: 'Pacifico', cursive; color: #FF69B4; }
        .newspaper { position: absolute; width: 250px; background: #fdf5e6; border: 1px solid #ccc; padding: 10px; font-family: 'Times New Roman', Times, serif; box-shadow: 5px 5px 15px rgba(0,0,0,0.2); animation: flyIn 2s ease-out forwards; }
        @keyframes flyIn { from { transform: translateX(-150vw) rotate(-20deg) scale(0.5); opacity: 0; } to { transform: translateX(0) rotate(var(--rotation)) scale(1); opacity: 1; } }
        .like-container { margin-top: 20px; position: relative; }
        .like-count { font-size: 28px; color: #FF1493; font-weight: bold; }
        .flying-heart { position: absolute; bottom: 0; left: 50%; font-size: 24px; color: red; pointer-events: none; animation: floatHeart 1.5s ease-out forwards; }
        @keyframes floatHeart { from { opacity: 1; transform: translate(-50%, 0) scale(1); } to { opacity: 0; transform: translate(var(--x-end), -150px) scale(0.5); } }
        .clouds { position: relative; width: 90%; max-width: 1000px; height: 60vh; margin: 20px auto; }
        .cloud { position: absolute; width: 200px; height: 120px; background: #fff; border-radius: 100px; box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1); cursor: pointer; transition: transform 0.3s ease, box-shadow 0.3s ease; animation: float 8s infinite ease-in-out; }
        .cloud:before, .cloud:after { content: ''; position: absolute; background: #fff; border-radius: 50%; }
        .cloud:before { width: 120px; height: 120px; top: -60px; left: 20px; }
        .cloud:after { width: 80px; height: 80px; top: -40px; right: 20px; }
        .cloud:hover { transform: scale(1.1) translateY(-10px); }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }
        .cloud.c1 { top: 10%; left: 10%; animation-delay: -2s; } .cloud.c2 { top: 40%; left: 25%; animation-delay: -4s; } .cloud.c3 { top: 20%; left: 60%; animation-delay: 0s; } .cloud.c4 { top: 50%; left: 75%; animation-delay: -6s; }
        #game-section { text-align: center; }
        #game-canvas { border: 3px solid #FF69B4; background: #FFF0F5; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); cursor: none; }
        .dim-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 500; opacity: 0; pointer-events: none; transition: opacity 2s ease; }
        .dim-overlay.dim { opacity: 1; }
        #summon-assistant-btn { margin-top: 15px; background-color: #4ab3ff; } #summon-assistant-btn:hover { background-color: #0088ff; }
        .copy-code { color: #FF1493; text-decoration: underline; cursor: pointer; font-weight: bold; }
        #toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 10px 20px; border-radius: 8px; z-index: 2000; opacity: 0; transition: opacity 0.5s; }
        #treasure { text-align: center; }
        .chest { width: 200px; height: 160px; background: linear-gradient(#DAA520, #FFD700); margin: 30px auto; border-radius: 10px; position: relative; transform-style: preserve-3d; transition: transform 2s; }
        .chest.open { transform: perspective(800px) rotateX(-60deg); }
        .light-ray { position: absolute; top: -50px; left: 50%; width: 10px; height: 200px; background: linear-gradient(to bottom, rgba(255, 255, 224, 0.8), transparent); transform: translateX(-50%) perspective(500px) rotateX(20deg); opacity: 0; transition: opacity 2s; }
        .chest.open + .light-ray { opacity: 1; }
        @media (max-width: 768px) {
             .heart-lock { width: 320px; height: 280px; } .digit { width: 30px; height: 40px; }
             .clouds { height: auto; display: flex; flex-direction: column; align-items: center; gap: 40px; }
             .cloud { position: relative !important; top: auto !important; left: auto !important; }
        }
    </style>
</head>
<body>

    <div id="lock-screen">
        <div class="heart-lock">
            <svg class="heart" viewBox="0 0 100 100" preserveAspectRatio="none"><path d="M 10,30 A 20,20 0,0,1 50,30 A 20,20 0,0,1 90,30 Q 90,60 50,90 Q 10,60 10,30 z" /></svg>
            <div class="digits"></div>
        </div>
        <div id="hint" onclick="showModal('hint-pop')">G·ª£i √Ω</div>
    </div>

    <div id="welcome" class="hidden">
        <div id="energy-bar"><div class="bar"></div></div>
        <div id="avatar-container" class="hidden">
            <div id="avatar" onclick="showModal('profile-pop')"></div>
            <div class="arrow-hint">·∫§n v√†o ƒë·ªÉ xem h·ªì s∆° c·ªßa b·∫°n</div>
        </div>
        <h1 class="welcome-text">
            ƒê√¢y l√† m√≥n qu√† do ducanhlesiucapcutis1zutru‚ú® d√†nh t·∫∑ng cho b·∫°n üòáüòáüòá
            <p>Sinh nh·∫≠t zui z·∫ª nh√© üéâüéâüéâ</p>
        </h1>
    </div>

    <div id="tram1" class="hidden" style="text-align: center;">
        <div id="main-tram1" class="hidden">
            <img src="https://i.imgur.com/your-bts-photo.jpg" alt="BTS Lineup" style="max-width:90%; border-radius:10px; margin-bottom: 15px;">
            <audio controls><source src="your-music.mp3" type="audio/mpeg"></audio>
            <div class="comments-container" style="height: 300px; overflow: hidden; position: relative; margin-top: 20px;"></div>
            <div class="like-container"><div class="like-count">0 th·∫£ tim</div></div>
            <button id="next2" style="margin-top: 20px;">Ti·∫øp t·ª•c h√†nh tr√¨nh</button>
        </div>
    </div>

    <div id="tram2" class="hidden">
        <div class="cat" style="font-size: 3em; text-align: center;">üê± Our Memories üê±</div>
        <div class="clouds">
            <div class="cloud c1" data-photo="https://i.imgur.com/photo1.jpg"></div>
            <div class="cloud c2" data-photo="https://i.imgur.com/photo2.jpg"></div>
            <div class="cloud c3" data-photo="https://i.imgur.com/photo3.jpg"></div>
            <div class="cloud c4" data-photo="https://i.imgur.com/photo4.jpg"></div>
        </div>
        <div style="text-align: center; margin-top: 20px;">
            <button id="next4">ƒê·∫øn tr·∫°m ngh·ªâ ch√¢n</button>
        </div>
    </div>

    <div id="tram4" class="hidden">
        <div class="dim-overlay"></div>
        <div id="game-section" class="hidden">
            <div id="game-info" style="color: white; font-size: 1.2em;">ƒêi·ªÉm: <span id="score-display">0</span></div>
            <canvas id="game-canvas"></canvas>
            <button id="summon-assistant-btn" class="hidden">Tri·ªáu h·ªìi tr·ª£ th·ªß üêü</button>
            <button id="open-gift" class="hidden">M·ªû QU√Ä</button>
        </div>
    </div>

    <div id="phase3" class="hidden">
        <div id="treasure" class="hidden">
            <div class="chest"></div>
            <div class="light-ray"></div>
            <h2>Ph·∫ßn th∆∞·ªüng 1: S·∫Ω ƒë∆∞·ª£c g·ª≠i cho b·∫°n qua mess v√†o t·ªëi nay!</h2>
            <div class="reward2" style="margin-top: 20px;">
                <img src="https://i.imgur.com/your-reminder-photo.jpg" alt="G√≥c nh·∫Øc nh·ªü" style="max-width:90%; border-radius:10px;">
                <p>T nghƒ© l√† l·ªõp ko ƒëi chs ƒëc r nma m vx ph·∫£i bao t ƒëi ƒÉng ƒë√≥ c·∫•m ƒëc b√πng üòãüòãüòã</p>
            </div>
        </div>
    </div>


    <div id="hint-pop" class="modal hidden"><div class="modal-content"><p>N·∫øu b·∫°n ch∆∞a bi·∫øt m·∫≠t kh·∫©u th√¨ h√£y xem l·∫°i thi·ªáp nh√≥ =))</p><button onclick="closeModal('hint-pop')">ƒê√≥ng</button></div></div>
    <div id="assistant-pop" class="modal hidden"><div class="modal-content"><h2>Ph·∫ßn Qu√† ƒê·∫ßu Ti√™n: Tr·ª£ Th·ªß üêü</h2><p>ƒêanh l√™ siu c·∫•p cuti s1zt! B·∫°n c√≥ th·ªÉ tri·ªáu h·ªìi tr·ª£ th·ªß n√†y khi c·∫ßn thi·∫øt.</p><button onclick="closeModal('assistant-pop', () => showModal('ticket-pop'))">OK</button></div></div>
    <div id="ticket-pop" class="modal hidden"><div class="modal-content"><h2>Ph·∫ßn Th∆∞·ªüng: Phi·∫øu B√© Ngoan</h2><img src="https://i.imgur.com/your-phieu-be-ngoan.jpg" alt="Phi·∫øu b√© ngoan" style="width:100%;"><button onclick="closeModal('ticket-pop', startWelcome)">B·∫Øt ƒë·∫ßu h√†nh tr√¨nh</button></div></div>
    <div id="profile-pop" class="modal hidden"><div class="modal-content"><h2>H·ªì S∆° C·ªßa B·∫°n</h2><p><b>T√™n gem th·ªß:</b> Nguy·ªÖn ƒê√¨nh D∆∞∆°ng</p><p><b>Rank:</b> Siucapgalangƒëepzai=))))</p><button id="next1">·∫§n ƒë·ªÉ xem ti·∫øp</button></div></div>
    <div id="notify-pop" class="modal hidden show"><div class="modal-content" style="cursor: pointer;"><p>B·∫°n c√≥ th√¥ng b√°o m·ªõi, h√£y ·∫•n v√†o ƒë·ªÉ xem!</p></div></div>
    <div id="announce-pop" class="modal hidden"><div class="modal-content"><h2 id="announce">BTS th√¥ng b√°o ra m·∫Øt th√†nh vi√™n th·ª© 8</h2></div></div>
    <div id="question-pop" class="modal hidden"><div class="modal-content"><p>Tr·∫£ l·ªùi c√¢u h·ªèi ƒë·ªÉ ti·∫øp t·ª•c =))): B·∫°n c√≥ th·∫•y c·∫£m ƒë·ªông r·ªõt n∆∞·ªõc m·∫Øt üò¢üò¢üò¢ v·ªõi m√≥n qu√† n√†y ko?</p><button id="coa" style="font-size: 20px; padding: 12px 24px; margin: 5px;">c√≥a</button><button id="hem" style="margin: 5px;">hem</button></div></div>
    <div id="message-pop" class="modal hidden"><div class="modal-content"><p id="message-text"></p><button onclick="closeModal('message-pop', continueToMemories)">Ti·∫øp t·ª•c</button></div></div>
    <div id="photo-viewer" class="modal hidden"><div class="modal-content"><img id="memory-photo" src="" style="max-width:100%;"><button onclick="closeModal('photo-viewer')">ƒê√≥ng</button></div></div>
    <div id="memories-pop" class="modal hidden"><div class="modal-content"><p>t √≠t ·∫£nh ch·ª•p chung vs m vl t√¨m m√£i ms t√¨m ƒëc √≥, n√™n bi·∫øt tr√¢n tr·ªçng t ik =))</p><button onclick="closeModal('memories-pop')">Okieee</button></div></div>
    <div id="recharge-pop" class="modal hidden"><div class="modal-content"><p>NƒÉng l∆∞·ª£ng s·∫Øp c·∫°n!</p><button id="nap">N·∫°p nƒÉng l∆∞·ª£ng</button></div></div>
    <div id="game-rules-pop" class="modal hidden"><div class="modal-content"><h2>Lu·∫≠t Ch∆°i</h2><p>Di chuy·ªÉn chu·ªôt ƒë·ªÉ ƒëi·ªÅu khi·ªÉn üòá.</p><p>ƒÇn üç¶üç∞ (+5ƒë), üéÇ (+10ƒë).</p><p>Tr√°nh üí£ (-3ƒë)!</p><button onclick="closeModal('game-rules-pop', initGame)">B·∫Øt ƒë·∫ßu!</button></div></div>
    <div id="assistant-needed-pop" class="modal hidden"><div class="modal-content"><p>C√≥ v·∫ª b·∫°n c·∫ßn s·ª± tr·ª£ gi√∫p!</p><button onclick="closeModal('assistant-needed-pop')">ƒê·ªÉ t√¥i th·ª≠ l·∫°i</button></div></div>
    <div id="phase3-pass-pop" class="modal hidden"><div class="modal-content">
        <p>ƒê·ªÉ m·ªü kho b√°u, h√£y g·ª≠i c√∫ ph√°p n√†y cho ducanhlesiucapcutis1zutru qua mess ƒë·ªÉ nh·∫≠n m·∫≠t kh·∫©u nh√© hehehe:</p>
        <p><span class="copy-code" onclick="copyCode(this)">toilanguyendinhduongtoixinhuasaunaysebaonuoiducanhlesiucapcutis1zutru‚ú®</span></p>
        <input id="pass-input2" type="text" placeholder="Nh·∫≠p m·∫≠t kh·∫©u" style="width: 80%; padding: 8px; margin-top: 10px;">
        <button id="submit-pass2" style="margin-top: 10px;">X√°c nh·∫≠n</button>
    </div></div>
    <div id="toast"></div>

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <script>
        // --- CONFIG & STATE MANAGEMENT ---
        const config = {
            password: '22082007',
            password2: 'oke =))',
            likeTarget: 22080,
            gameWinScore: 100
        };

        // Bi·∫øn tr·∫°ng th√°i ƒë·ªÉ qu·∫£n l√Ω lu·ªìng c·ªßa trang web
        const state = {
            energy: 100,
            choseHemFirst: false,
            assistantAvailable: false,
            assistantUsed: false,
            viewedClouds: 0,
            isAskingQuestion: false, // ƒê·ªÉ ki·ªÉm so√°t s·ª± ki·ªán tho√°t trang
        };

        // --- UTILITY FUNCTIONS ---
        const getEl = (id) => document.getElementById(id);
        const showModal = (id) => { getEl(id).classList.add('show'); };
        const closeModal = (id, callback) => {
            getEl(id).classList.remove('show');
            if (callback) setTimeout(callback, 500); // ƒê·ª£i hi·ªáu ·ª©ng k·∫øt th√∫c
        };
        const fadeTransition = (hideId, showId, callback) => {
            const hideEl = getEl(hideId);
            const showEl = getEl(showId);
            hideEl.style.transition = 'opacity 0.5s';
            hideEl.style.opacity = 0;
            setTimeout(() => {
                hideEl.classList.add('hidden');
                showEl.classList.remove('hidden');
                showEl.style.opacity = 0;
                setTimeout(() => { showEl.style.opacity = 1; }, 50);
                if (callback) callback();
            }, 500);
        };
        const updateEnergy = (amount) => {
            state.energy = Math.max(0, Math.min(100, state.energy + amount));
            const bar = document.querySelector('#energy-bar .bar');
            bar.style.width = `${state.energy}%`;
            if (state.energy < 20) {
                bar.style.backgroundColor = '#ff4d4d';
            } else {
                bar.style.backgroundColor = ''; // Revert to CSS gradient
            }
        };

        // --- GIAI ƒêO·∫†N 1: M·ªû KH√ìA & CH√ÄO M·ª™NG ---
        function setupLockScreen() {
            const digitsContainer = document.querySelector('.digits');
            digitsContainer.innerHTML = Array(config.password.length).fill(0).map((_, i) => `
                <div class="digit-container">
                    <button class="arrow-btn" onclick="changeDigit(${i}, 1)">‚ñ≤</button>
                    <div class="digit" id="d${i}">0</div>
                    <button class="arrow-btn" onclick="changeDigit(${i}, -1)">‚ñº</button>
                </div>`).join('');
        }

        let currentDigits = Array(config.password.length).fill(0);
        function changeDigit(index, delta) {
            currentDigits[index] = (currentDigits[index] + delta + 10) % 10;
            getEl(`d${index}`).textContent = currentDigits[index];
            if (currentDigits.join('') === config.password) unlock();
        }

        function unlock() {
            fadeTransition('lock-screen', '', () => showModal('assistant-pop'));
        }

        function startWelcome() {
            fadeTransition('', 'welcome', () => {
                getEl('welcome').classList.add('show');
                confetti({ particleCount: 200, spread: 100, origin: { y: 0.6 } });
                updateEnergy(0); // Kh·ªüi t·∫°o thanh nƒÉng l∆∞·ª£ng
                getEl('avatar-container').classList.remove('hidden');
            });
        }
        
        getEl('next1').onclick = () => {
            closeModal('profile-pop', () => {
                updateEnergy(-10);
                fadeTransition('welcome', 'tram1', () => showModal('notify-pop'));
            });
        };
        
        // --- GIAI ƒêO·∫†N 2, TR·∫†M 1: BTS ---
        getEl('notify-pop').onclick = () => {
            closeModal('notify-pop', () => {
                showModal('announce-pop');
                setTimeout(() => {
                    closeModal('announce-pop');
                    // Hi·ªáu ·ª©ng b√°o bay c√≥ th·ªÉ th√™m ·ªü ƒë√¢y n·∫øu mu·ªën
                    getEl('main-tram1').classList.remove('hidden');
                    startCommentsAndLikes();
                }, 2500);
            });
        };

        function startCommentsAndLikes() {
            const comments = [
                { avatar: 'ü¶Å', text: 'Ng·∫ßu ƒë√©t üòéüòéüòé' }, { avatar: 'üêØ', text: 'Wow a n√†y ƒëzai th·∫ø' },
                { avatar: 'üê∂', text: 'Anh ∆°i em qu·∫°t anh ü•∞' }, { avatar: 'üêµ', text: 'ƒêzai qu√° a ∆°i' },
                { avatar: 'ü¶ä', text: 'Anh n√†y v√¥ BTS l√† qu√° chu·∫©n r' }, { avatar: 'üê∑', text: 'Wow ü§©ü§©ü§©' },
                { avatar: 'üê∞', text: 'ko ngo2f tr√™n ƒë·ªùi c√≥ ng ƒë·∫πp z lun √° üòä' }, { avatar: 'üêª', text: '√ä ƒë·ªânh z·ªØ v' },
                { avatar: 'üê®', text: 'Ng·∫ßu ƒë√©t üòéüòéüòé' }, { avatar: 'üêº', text: 'Wow a n√†y ƒëzai th·∫ø' },
                { avatar: 'üê±', text: 'Anh ∆°i em y√™u anh ‚ù§‚ù§‚ù§' }
            ];
            
            const commentContainer = document.querySelector('.comments-container');
            comments.forEach((c, i) => {
                setTimeout(() => {
                    const com = document.createElement('div');
                    com.style.cssText = `position:absolute; bottom:-50px; left:${Math.random()*80+10}%; background:rgba(255,192,203,0.9); padding:8px 16px; border-radius:20px; animation:riseUp 5s linear forwards;`;
                    com.innerHTML = `<span>${c.avatar}</span> ${c.text}`;
                    commentContainer.appendChild(com);
                    setTimeout(() => com.remove(), 5000);
                }, i * 500);
            });
            
            animateLikes(config.likeTarget);
        }
        
        function animateLikes(target) { /* ... Gi·ªØ nguy√™n nh∆∞ c≈© ... */ }
        getEl('next2').onclick = () => {
            updateEnergy(-15);
            fadeTransition('tram1', '', () => {
                state.isAskingQuestion = true;
                showModal('question-pop')
            });
        };

        // --- GIAI ƒêO·∫†N 2, TR·∫†M 2: C√ÇU H·ªéI & K√ù ·ª®C ---
        getEl('coa').onclick = () => {
            state.isAskingQuestion = false; // Ng·ª´ng theo d√µi s·ª± ki·ªán tho√°t trang
            const message = state.choseHemFirst ? "√™ d·ªói nka tr·ªùi l√†m v·∫≠y r·ªìi m√† kh√¥ng c·∫£m ƒë·ªông" : "weo ch·ªçn c√≥a lun h·∫ª, tr·ªùi oie ƒë√°ng iu z üòçüòçüòç";
            getEl('message-text').textContent = message;
            closeModal('question-pop', () => showModal('message-pop'));
        };
        getEl('hem').addEventListener('mouseover', () => {
            state.choseHemFirst = true;
            const btn = getEl('hem');
            const parent = btn.parentElement.getBoundingClientRect();
            btn.style.position = 'absolute';
            btn.style.top = `${Math.random() * (parent.height - 50)}px`;
            btn.style.left = `${Math.random() * (parent.width - 100)}px`;
        });
        
        window.addEventListener('beforeunload', (event) => {
            if (state.isAskingQuestion) {
                event.preventDefault();
                event.returnValue = 'n·∫øu b·∫°n tho√°t kh·ªèi web ngay l√∫c n√†y th√¨ c√≥ nghƒ©a l√† b·∫°n ƒëang c·∫£m ƒë·ªông r·ªõt n∆∞·ªõc m·∫Øt =)))';
                return 'n·∫øu b·∫°n tho√°t kh·ªèi web ngay l√∫c n√†y th√¨ c√≥ nghƒ©a l√† b·∫°n ƒëang c·∫£m ƒë·ªông r·ªõt n∆∞·ªõc m·∫Øt =)))';
            }
        });
        
        function continueToMemories() {
            updateEnergy(-15);
            fadeTransition('message-pop', 'tram2');
        }

        document.querySelectorAll('.cloud').forEach(cloud => {
            cloud.onclick = () => {
                getEl('memory-photo').src = cloud.dataset.photo;
                showModal('photo-viewer');
                if (!cloud.classList.contains('viewed')) {
                    cloud.classList.add('viewed');
                    cloud.style.opacity = '0.7';
                    state.viewedClouds++;
                    if (state.viewedClouds === 4) {
                        setTimeout(() => showModal('memories-pop'), 1000);
                    }
                }
            }
        });

        getEl('next4').onclick = () => {
            updateEnergy(-20);
            fadeTransition('tram2', 'tram4', startEnergyDrain);
        };

        // --- GIAI ƒêO·∫†N 2, TR·∫†M 4: GAME ---
        let game, ctx, player, items, score, gameLoop, gamePhase;
        function startEnergyDrain() {
            document.querySelector('.dim-overlay').classList.add('dim');
            document.querySelector('#energy-bar .bar').classList.add('flashing');
            setTimeout(() => showModal('recharge-pop'), 1500);
        }
        getEl('nap').onclick = () => closeModal('recharge-pop', () => showModal('game-rules-pop'));
        
        function initGame() {
            document.querySelector('#energy-bar .bar').classList.remove('flashing');
            getEl('game-section').classList.remove('hidden');
            game = getEl('game-canvas');
            ctx = game.getContext('2d');
            game.width = Math.min(window.innerWidth * 0.9, 500);
            game.height = 400;

            player = { x: game.width / 2, y: game.height - 40, size: 20, emoji: 'üòá' };
            items = []; score = 0; gamePhase = 'normal';
            state.assistantAvailable = false; state.assistantUsed = false;
            getEl('score-display').textContent = score;
            getEl('open-gift').classList.add('hidden');
            getEl('summon-assistant-btn').classList.add('hidden');
            
            setTimeout(() => { gamePhase = 'impossible'; }, 20000); // Sau 20s, game kh√≥
            
            game.onmousemove = e => { player.x = e.clientX - game.getBoundingClientRect().left; };
            if(gameLoop) cancelAnimationFrame(gameLoop);
            gameLoop = requestAnimationFrame(updateGame);
            setInterval(spawnItem, 800);
        }

        function spawnItem() {
            const itemTypes = {
                good: [{ emoji: 'üç¶', points: 5, size: 20 }, { emoji: 'üç∞', points: 5, size: 20 }, { emoji: 'üéÇ', points: 10, size: 25 }],
                bad: [{ emoji: 'üí£', points: -3, size: 20 }]
            };
            let type;
            if (gamePhase === 'impossible' && !state.assistantUsed) {
                type = itemTypes.bad[0];
            } else {
                const choice = Math.random() > 0.3 ? 'good' : 'bad';
                type = itemTypes[choice][Math.floor(Math.random() * itemTypes[choice].length)];
            }
            items.push({ x: Math.random() * game.width, y: -30, ...type, speed: Math.random() * 2 + 1.5 });
        }
        
        function updateGame() {
            ctx.clearRect(0, 0, game.width, game.height);
            ctx.font = `${player.size * 1.5}px Arial`;
            ctx.fillText(player.emoji, player.x - player.size, player.y + player.size/2);

            if (state.assistantUsed) {
                ctx.beginPath(); ctx.arc(player.x, player.y, player.size * 2, 0, Math.PI * 2);
                ctx.fillStyle = 'rgba(74, 179, 255, 0.3)'; ctx.fill();
            }

            for (let i = items.length - 1; i >= 0; i--) {
                let item = items[i]; item.y += item.speed;
                ctx.font = `${item.size * 1.5}px Arial`;
                ctx.fillText(item.emoji, item.x - item.size, item.y + item.size/2);
                
                const dist = Math.hypot(player.x - item.x, player.y - item.y);
                if (dist < player.size + item.size) {
                    if (item.points < 0 && state.assistantUsed) { // Tr·ª£ th·ªß b·∫£o v·ªá
                        items.splice(i, 1); continue;
                    }
                    score += item.points;
                    items.splice(i, 1);
                } else if (item.y > game.height + item.size) {
                    items.splice(i, 1);
                }
            }
            score = Math.max(0, score);
            getEl('score-display').textContent = score;

            if (gamePhase === 'impossible' && !state.assistantAvailable && !state.assistantUsed) {
                state.assistantAvailable = true;
                showModal('assistant-needed-pop');
                getEl('summon-assistant-btn').classList.remove('hidden');
            }
            
            if (score >= config.gameWinScore) {
                getEl('open-gift').classList.remove('hidden');
                cancelAnimationFrame(gameLoop); return;
            }
            gameLoop = requestAnimationFrame(updateGame);
        }

        getEl('summon-assistant-btn').onclick = () => {
            if (state.assistantAvailable && !state.assistantUsed) {
                state.assistantUsed = true;
                player.emoji = 'üêü';
                getEl('summon-assistant-btn').classList.add('hidden');
            } else if (!state.assistantAvailable){
                getEl('toast').textContent = 'Tr·ª£ th·ªß ƒëang b·∫≠n √≤i';
                getEl('toast').style.opacity = 1;
                setTimeout(() => { getEl('toast').style.opacity = 0; }, 2000);
            }
        };

        // S·ª¨A L·ªñI: G√°n s·ª± ki·ªán cho n√∫t "M·ªû QU√Ä"
        getEl('open-gift').onclick = () => {
            updateEnergy(100); // H·ªìi ƒë·∫ßy nƒÉng l∆∞·ª£ng
            fadeTransition('tram4', '', () => showModal('phase3-pass-pop'));
        };

        // --- GIAI ƒêO·∫†N 3: KHO B√ÅU ---
        function copyCode(element) {
            navigator.clipboard.writeText(element.textContent);
            getEl('toast').textContent = 'ƒê√£ sao ch√©p!';
            getEl('toast').style.opacity = 1;
            setTimeout(() => { getEl('toast').style.opacity = 0; }, 2000);
        }

        getEl('submit-pass2').onclick = () => {
            if (getEl('pass-input2').value === config.password2) {
                closeModal('phase3-pass-pop', () => {
                    fadeTransition('', 'phase3', () => {
                        getEl('treasure').classList.remove('hidden');
                        setTimeout(() => getEl('treasure').querySelector('.chest').classList.add('open'), 500);
                    });
                });
            } else {
                alert('M·∫≠t kh·∫©u sai!');
            }
        };

        // --- KH·ªûI ƒê·ªòNG ---
        window.onload = () => {
            setupLockScreen();
        };

    </script>
</body>
</html>
