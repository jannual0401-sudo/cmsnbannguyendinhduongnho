<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M√≥n Qu√† K·ª∑ Ni·ªám - Sinh Nh·∫≠t Vui V·∫ª</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&family=Quicksand:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #FF69B4;
            --secondary-color: #FFC0CB;
            --background-color: #FFF5EE;
            --text-color: #4A4A4A;
        }
        html { box-sizing: border-box; }
        *, *:before, *:after { box-sizing: inherit; }
        body {
            font-family: 'Quicksand', sans-serif; background-color: var(--background-color);
            color: var(--text-color); margin: 0; padding: 15px; display: flex;
            justify-content: center; align-items: center; min-height: 100vh; overflow: hidden;
            transition: background-color 1s ease; text-align: center;
        }
        .hidden { display: none !important; }
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6); display: flex; justify-content: center;
            align-items: center; z-index: 1000; opacity: 0; visibility: hidden;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }
        .modal.show { opacity: 1; visibility: visible; }
        .modal-content {
            background: #FFFFFF; padding: 25px 30px; border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            max-width: 90%; width: 450px; transform: scale(0.9);
            transition: transform 0.4s ease;
        }
        .modal.show .modal-content { transform: scale(1); }
        button {
            background: var(--primary-color); color: white; border: none; padding: 12px 24px;
            border-radius: 10px; cursor: pointer; font-size: 16px; font-weight: bold;
            font-family: 'Quicksand', sans-serif; transition: background 0.3s ease, transform 0.2s ease;
        }
        button:hover { background: #FF1493; transform: translateY(-3px) scale(1.05); }
        #lock-screen { width: 100%; }
        .heart-lock { position: relative; width: 300px; height: 270px; margin: 20px auto; }
        .heart { fill: var(--secondary-color); stroke: var(--primary-color); stroke-width: 3; animation: pulse 1.5s infinite ease-in-out; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.03); } }
        .digits { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: flex; gap: 10px; }
        .digit-container { display: flex; flex-direction: column; align-items: center; }
        .digit {
            background: #FFFFFF; border: 2px solid var(--primary-color); border-radius: 8px;
            width: 30px; height: 40px; display: flex; align-items: center;
            justify-content: center; font-weight: bold; font-size: 18px; margin: 3px 0;
        }
        .arrow-btn { background: transparent; color: var(--primary-color); border: none; padding: 3px; font-size: 16px; cursor: pointer; }
        #hint { margin-top: 20px; font-size: 14px; color: var(--primary-color); cursor: pointer; font-weight: bold; }
        #welcome { opacity: 0; transition: opacity 1s ease; width: 100%; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        #welcome.show { opacity: 1; }
        .welcome-text { font-size: 2em; font-family: 'Pacifico', cursive; color: var(--primary-color); text-shadow: 0 2px 4px rgba(0,0,0,0.1); animation: fadeIn-Up 1.5s ease-out forwards; }
        .welcome-text p { margin: 5px 0; font-family: 'Quicksand', sans-serif; font-size: 0.6em; font-weight: 500; color: #555; }
        @keyframes fadeIn-Up { 0% { opacity: 0; transform: translateY(20px); } 100% { opacity: 1; transform: translateY(0); } }
        #energy-bar { position: fixed; top: 10px; right: 10px; width: 100px; height: 10px; background: #F0F0F0; border-radius: 5px; overflow: hidden; box-shadow: 0 1px 2px rgba(0,0,0,0.1); z-index: 1000; }
        .bar { height: 100%; background: linear-gradient(to right, #76E071, #38A333); transition: width 1s ease, background-color 1s ease; }
        .bar.flashing { animation: flash 1s infinite; }
        @keyframes flash { 0%, 100% { background: #ff4d4d; } 50% { background: #ffb3b3; } }
        #avatar-container { position: fixed; top: 10px; left: 10px; z-index: 1000; }
        #avatar { width: 30px; height: 30px; background-image: url('https://i.imgur.com/6bH0j8v.png'); background-size: cover; border-radius: 50%; cursor: pointer; border: 2px solid var(--secondary-color); }
        .arrow-hint { position: absolute; top: -5px; left: 40px; background: white; padding: 3px 6px; border-radius: 5px; box-shadow: 0 1px 2px rgba(0,0,0,0.2); white-space: nowrap; animation: fadeIn-Up 1s 2s ease-out forwards; opacity:0; font-size: 0.8em; }
        #tram1 { width: 90%; max-width: 400px; margin: 20px auto; }
        #announce-container { margin-bottom: 15px; }
        #announce { font-size: 1.8em; font-family: 'Pacifico', cursive; color: var(--primary-color); }
        /* C·∫¢I TI·∫æN 2: CSS cho b√°o bay v√† comment */
        .newspapers { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; overflow: hidden; z-index: 10; }
        .newspaper { position: absolute; width: 60%; min-width: 200px; background: #fdf5e6; border: 1px solid #ccc; padding: 8px; font-family: 'Times New Roman', Times, serif; box-shadow: 3px 3px 10px rgba(0,0,0,0.2); animation: flyIn3D 2.5s cubic-bezier(0.25, 1, 0.5, 1) forwards; }
        .newspaper.style-2 { background: #e6f7ff; border-color: #91d5ff; }
        @keyframes flyIn3D { from { opacity: 0; transform: perspective(800px) translateX(-150vw) rotateY(60deg) scale(0.7); } to { opacity: 1; transform: perspective(800px) translateX(var(--x-pos)) translateY(var(--y-pos)) rotateY(0deg) rotateZ(var(--rotation)) scale(1); } }
        #newspaper-wall { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--background-color); z-index: 998; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        #newspaper-wall h2 { color: var(--primary-color); font-family: 'Pacifico', cursive; }
        #main-tram1-content { position: relative; } /* Container cho ·∫£nh v√† comment */
        #comment-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        .fan-comment {
            position: absolute; background: rgba(0, 0, 0, 0.6); color: white; padding: 5px 10px; border-radius: 15px; display: flex; align-items: center; gap: 8px;
            font-size: 0.8em; animation: comment-fade-in-scale 0.7s ease-out forwards;
            opacity: 0; transform: scale(0.5);
        }
        @keyframes comment-fade-in-scale { to { opacity: 1; transform: scale(1); } }
        .fan-comment .avatar { font-size: 1.2em; }
        #main-tram1 img { max-width: 100%; border-radius: 10px; margin-bottom: 10px; }
        #music-player { width: 100%; }
        .like-container { margin-top: 10px; font-size: 1em; font-weight: bold; position: relative; min-height: 50px; }
        #like-count { color: var(--primary-color); font-size: 1.2em; }
        .flying-heart { position: absolute; bottom: 0; left: 50%; font-size: 18px; pointer-events: none; animation: floatHeart 1.5s ease-out forwards; }
        @keyframes floatHeart { from { opacity: 1; transform: translateY(0) translateX(-50%) scale(1) rotate(0); } to { opacity: 0; transform: translateY(-100px) translateX(calc(-50% + var(--x-end))) scale(0.5) rotate(var(--rot-end)); } }
        #memories { width: 90%; max-width: 400px; margin: 20px auto; }
        .cat { font-size: 2.5em; text-align: center; font-family: 'Pacifico', cursive; color: var(--primary-color); margin-bottom: 15px; }
        .clouds { position: relative; width: 100%; height: auto; display: flex; flex-direction: row; flex-wrap: wrap; justify-content: space-around; align-items: center; gap: 15px; }
        .cloud { position: relative !important; width: 45%; min-width: 100px; height: auto; aspect-ratio: 2 / 1.2; background: #fff; border-radius: 50px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); cursor: pointer; transition: transform 0.3s ease, box-shadow 0.3s ease, opacity 0.5s ease; animation: float 5s infinite ease-in-out; }
        .cloud:hover { transform: scale(1.05) translateY(-5px); }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        #tram4 { width: 90%; max-width: 400px; margin: 20px auto; }
        #game-section { position: relative; z-index: 501; }
        #game-canvas { border: 2px solid var(--primary-color); background: #FFF0F5; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: none; width: 100% !important; height: auto !important; aspect-ratio: 5 / 4; display: block; margin: 0 auto; }
        #phase3 { width: 90%; max-width: 400px; margin: 20px auto; }
        #treasure { text-align: center; }
        .chest-container { perspective: 800px; margin-bottom: 20px; display: inline-block; }
        .chest { width: 150px; height: 120px; background: linear-gradient(#DAA520, #FFD700); border-radius: 8px; position: relative; transform-style: preserve-3d; transition: transform 1.5s cubic-bezier(0.68, -0.55, 0.27, 1.55); cursor: pointer; }
        .chest.open { transform: rotateX(45deg); }
        #profile-pop img.profile-avatar { width: 80px; height: 80px; border-radius: 50%; margin: 0 auto 15px auto; border: 3px solid var(--primary-color); }
        @media (min-width: 769px) {
            body { padding: 0; } .welcome-text { font-size: 2.5em; }
            #tram1 { max-width: 600px; } #announce { font-size: 2.5em; }
            #memories { max-width: 1000px; } .cat { font-size: 3em; }
            .clouds { flex-direction: row; flex-wrap: nowrap; height: 60vh; }
            .cloud { position: absolute !important; width: 200px; aspect-ratio: auto; }
            .cloud.c1 { top: 10%; left: 10%; } .cloud.c2 { top: 40%; left: 25%; } .cloud.c3 { top: 20%; left: 60%; } .cloud.c4 { top: 50%; left: 75%; }
            .fan-comment { font-size: 1em; }
            #game-canvas { aspect-ratio: 500 / 400; }
        }
    </style>
</head>
<body>
    
    <div id="lock-screen"> /* ... N·ªôi dung m√†n h√¨nh kh√≥a kh√¥ng ƒë·ªïi ... */ </div>
    <div id="welcome" class="hidden"> /* ... N·ªôi dung ch√†o m·ª´ng kh√¥ng ƒë·ªïi ... */ </div>
    <div id="newspaper-wall" class="hidden">
        <h2>B√°o ch√≠ ƒë∆∞a tin r·∫ßm r·ªô!</h2>
        <p>M·ªôt hi·ªán t∆∞·ª£ng m·ªõi s·∫Øp ƒë∆∞·ª£c c√¥ng b·ªë...</p>
        <button id="view-main-news">Xem tin ch√≠nh</button>
    </div>
    <div id="tram1" class="hidden">
        <div id="announce-container">
             <div id="announce" class="hidden">BTS ch√≠nh th·ª©c c√¥ng b·ªë th√†nh vi√™n th·ª© 8!</div>
        </div>
        <div class="newspapers hidden"></div>
        <div id="main-tram1" class="hidden">
            <div id="main-tram1-content">
                <img src="https://i.imgur.com/uR6G6dY.jpeg" alt="BTS Lineup">
                <div id="comment-overlay"></div>
            </div>
            <audio id="music-player" controls loop><source src="https://cdn.glitch.global/c31a147a-0552-411a-9694-88623b3a0323/dynamite.mp3?v=1670322744883" type="audio/mpeg"></audio>
            <div class="like-container"> <div id="like-count">0 th·∫£ tim</div> </div>
            <button id="next2" style="margin-top: 15px;">Ti·∫øp t·ª•c h√†nh tr√¨nh</button>
        </div>
    </div>
    <div id="tram2" class="hidden"> /* ... N·ªôi dung tr·∫°m 2 kh√¥ng ƒë·ªïi ... */ </div>
    <div id="tram4" class="hidden"> /* ... N·ªôi dung tr·∫°m 4 v√† game kh√¥ng ƒë·ªïi ... */ </div>
    <div id="phase3" class="hidden">
        <div id="treasure">
            <div class="chest-container"> <div class="chest"></div> <div class="light-beam"></div> </div>
            </div>
    </div>

    <div id="energy-bar" class="hidden"><div class="bar"></div></div>
    <div id="avatar-container" class="hidden"><div id="avatar"></div><div class="arrow-hint">·∫§n v√†o ƒë·ªÉ xem h·ªì s∆° c·ªßa b·∫°n</div></div>
    <div id="toast"></div>
    <div id="hint-pop" class="modal"> /* ... N·ªôi dung kh√¥ng ƒë·ªïi ... */ </div>
    <div id="assistant-pop" class="modal"> /* ... N·ªôi dung kh√¥ng ƒë·ªïi ... */ </div>
    <div id="ticket-pop" class="modal"> /* ... N·ªôi dung kh√¥ng ƒë·ªïi ... */ </div>
    <div id="profile-pop" class="modal"><div class="modal-content">
        <h2>H·ªì S∆° C·ªßa B·∫°n</h2>
        <img src="https://i.imgur.com/6bH0j8v.png" alt="Avatar" class="profile-avatar">
        <p><b>T√™n gem th·ªß:</b> Nguy·ªÖn ƒê√¨nh D∆∞∆°ng</p>
        <p><b>Rank:</b> Siucapgalangƒëepzai=))))</p>
        <button id="next1">·∫§n ƒë·ªÉ xem ti·∫øp</button>
    </div></div>
    <div id="notify-pop" class="modal"><div class="modal-content" style="cursor: pointer;"><p>üîî B·∫°n c√≥ th√¥ng b√°o m·ªõi, h√£y ·∫•n v√†o ƒë·ªÉ xem!</p></div></div>
    <div id="question-pop" class="modal"><div class="modal-content">
        <p>Tr·∫£ l·ªùi c√¢u h·ªèi ƒë·ªÉ ti·∫øp t·ª•c =))):<br>B·∫°n c√≥ th·∫•y c·∫£m ƒë·ªông r·ªõt n∆∞·ªõc m·∫Øt üò¢üò¢üò¢ v·ªõi m√≥n qu√† n√†y ko?</p>
        <button id="coa" style="font-size: 24px; padding: 15px 30px; margin: 5px;">c√≥a</button>
        <button id="hem" style="position: relative; margin: 5px;">hem</button>
    </div></div>
    <div id="coa-response-pop" class="modal"><div class="modal-content">
        <p style="font-size: 1.5em; font-family: 'Pacifico', cursive; color: var(--primary-color);">weo ch·ªçn c√≥a lun h·∫ª, tr·ªùi oie ƒë√°ng iu z üòçüòçüòç</p>
        <button id="continue-to-tram2">Hihi ng·∫°i qu√°</button>
    </div></div>
    <div id="photo-viewer" class="modal"> /* ... N·ªôi dung kh√¥ng ƒë·ªïi ... */ </div>
    <div id="memories-pop" class="modal"> /* ... N·ªôi dung kh√¥ng ƒë·ªïi ... */ </div>
    <div id="recharge-pop" class="modal"> /* ... N·ªôi dung kh√¥ng ƒë·ªïi ... */ </div>
    <div id="game-rules-pop" class="modal"> /* ... N·ªôi dung kh√¥ng ƒë·ªïi ... */ </div>
    <div id="assistant-needed-pop" class="modal"> /* ... N·ªôi dung kh√¥ng ƒë·ªïi ... */ </div>
    <div id="phase3-pass-pop" class="modal"> /* ... N·ªôi dung kh√¥ng ƒë·ªïi ... */ </div>
    <div id="notify-continue-pop" class="modal"> /* ... N·ªôi dung kh√¥ng ƒë·ªïi ... */ </div>
    <div id="reward1-pop" class="modal"><div class="modal-content">
        <h2>Ph·∫ßn th∆∞·ªüng 1: S·∫Ω ƒë∆∞·ª£c g·ª≠i cho b·∫°n qua mess v√†o t·ªëi nay! üéÅ</h2>
        <button onclick="closeModal('reward1-pop', () => showModal('forgot-pop'))">Tuy·ªát v·ªùi!</button>
    </div></div>
    <div id="forgot-pop" class="modal"><div class="modal-content">
        <p style="font-size: 1.3em;"> khoan... h√¨nh nh∆∞ b·∫°n c√≥ qu√™n g√¨ kh√¥ng nh·ªâ ü§î</p>
        <button onclick="closeModal('forgot-pop', () => showModal('reminder-pop'))">Xem ngay</button>
    </div></div>
    <div id="reminder-pop" class="modal"><div class="modal-content">
        <h3>G√≥c nh·∫Øc nh·ªü nh·∫π üìù</h3>
        <img src="https://i.imgur.com/eBf2g6v.png" alt="G√≥c nh·∫Øc nh·ªü" style="max-width:90%; border-radius:10px;">
        <p style="font-size: 1.1em; font-weight: 500; margin-top: 10px;">T nghƒ© l√† l·ªõp ko ƒëi chs ƒëc r nma m vx ph·∫£i bao t ƒëi ƒÉng ƒë√≥ c·∫•m ƒëc b√πng üòãüòãüòã</p>
        <button style="margin-top: 15px;" onclick="closeModal('reminder-pop')">Okie la</button>
    </div></div>


    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <script>
        const config = { password: '22082007', password2: 'oke =))', likeTarget: 22080, gameWinScore: 100 };
        const state = { energy: 100, assistantAvailable: false, assistantUsed: false, viewedClouds: 0 };
        const getEl = (id) => document.getElementById(id);
        const showModal = (id) => getEl(id).classList.add('show');
        const closeModal = (id, callback) => { getEl(id).classList.remove('show'); if (callback) setTimeout(callback, 400); };
        const fadeTransition = (hideId, showId, callback) => {
            const hideEl = getEl(hideId); const showEl = getEl(showId);
            if (hideEl) { hideEl.style.transition = 'opacity 0.5s'; hideEl.style.opacity = 0; }
            setTimeout(() => {
                if (hideEl) hideEl.classList.add('hidden');
                if (showId) { showEl.classList.remove('hidden'); showEl.style.opacity = 0; setTimeout(() => { showEl.style.opacity = 1; if (showEl.classList.contains('modal')) showEl.classList.add('show'); }, 50); }
                if (callback) callback();
            }, 500);
        };
        const updateEnergy = (amount) => { /* ... H√†m kh√¥ng ƒë·ªïi ... */ };
        const showToast = (message) => { /* ... H√†m kh√¥ng ƒë·ªïi ... */ };
        
        // --- GIAI ƒêO·∫†N 2: TH√îNG B√ÅO BTS & COMMENT ---
        getEl('notify-pop').onclick = () => {
            closeModal('notify-pop', () => {
                const announceEl = getEl('announce');
                announceEl.classList.remove('hidden');
                setTimeout(() => {
                    announceEl.style.transition = 'opacity 1s'; announceEl.style.opacity = 0;
                    showNewspapers();
                }, 2500);
            });
        };

        function showNewspapers() {
            const newspapersContainer = document.querySelector('.newspapers');
            newspapersContainer.classList.remove('hidden');
            // C·∫¢I TI·∫æN 2: TƒÉng s·ªë b√°o, th√™m style v√† ch·ªânh v·ªã tr√≠ tr√™n mobile
            for (let i = 0; i < 15; i++) {
                const np = document.createElement('div');
                np.className = `newspaper ${Math.random() > 0.6 ? 'style-2' : ''}`;
                np.style.setProperty('--x-pos', `${Math.random() * 80 - 40}vw`);
                np.style.setProperty('--y-pos', `${Math.random() * 60 - 30}vh`);
                np.style.setProperty('--rotation', `${Math.random() * 40 - 20}deg`);
                np.innerHTML = `<h3>HOT NEWS!</h3><p>BTS RA M·∫ÆT TH√ÄNH VI√äN TH·ª® 8!</p>`;
                newspapersContainer.appendChild(np);
            }
            setTimeout(() => {
                newspapersContainer.style.transition = 'opacity 1s'; newspapersContainer.style.opacity = 0;
                fadeTransition('', 'newspaper-wall');
            }, 3000);
        }
        
        getEl('view-main-news').onclick = () => {
             fadeTransition('newspaper-wall', '', () => {
                getEl('main-tram1').classList.remove('hidden');
                getEl('music-player').play().catch(e => console.error("L·ªói ph√°t nh·∫°c:", e));
                animateLikes(config.likeTarget);
                // C·∫¢I TI·∫æN 2: Hi·ªÉn th·ªã comment c·ªßa fan
                showFanComments();
            });
        }
        
        function showFanComments() {
            const overlay = getEl('comment-overlay');
            const comments = [
                { a: 'ü¶Å', c: 'Ng·∫ßu ƒë√©t üòéüòéüòé' }, { a: 'üê∂', c: '√ä ƒë·ªânh z·ªØ v' },
                { a: 'üêØ', c: 'Wow a n√†y ƒëzai th·∫ø' }, { a: 'üêµ', c: 'Anh ∆°i em qu·∫°t anh ü•∞' },
                { a: 'ü¶ä', c: 'ƒêzai qu√° a ∆°i' }, { a: 'üê∑', c: 'Anh n√†y v√¥ BTS l√† qu√° chu·∫©n r' },
                { a: 'üê∞', c: 'Wow ü§©ü§©ü§©' }, { a: 'üê®', c: 'ko ngo2f tr√™n ƒë·ªùi c√≥ ng ƒë·∫πp z lun √° üòä' },
                { a: 'üêª', c: 'Ng·∫ßu ƒë√©t üòéüòéüòé' }, { a: 'üêº', c: 'Wow a n√†y ƒëzai th·∫ø' },
            ];
            const specialComment = { a: 'üê±', c: 'Anh ∆°i em y√™u anh ‚ù§‚ù§‚ù§' };
            
            comments.sort(() => Math.random() - 0.5); // X√°o tr·ªôn comment
            
            let delay = 1000;
            comments.forEach(comment => {
                setTimeout(() => {
                    const commentEl = document.createElement('div');
                    commentEl.className = 'fan-comment';
                    commentEl.style.top = `${10 + Math.random() * 70}%`;
                    commentEl.style.left = `${5 + Math.random() * 50}%`;
                    commentEl.innerHTML = `<span class="avatar">${comment.a}</span><p>${comment.c}</p>`;
                    overlay.appendChild(commentEl);
                }, delay);
                delay += Math.random() * 1000 + 500;
            });
            
            // Comment ƒë·∫∑c bi·ªát lu√¥n ·ªü cu·ªëi
            setTimeout(() => {
                const specialEl = document.createElement('div');
                specialEl.className = 'fan-comment';
                specialEl.style.top = `80%`;
                specialEl.style.left = `25%`;
                specialEl.style.background = 'var(--primary-color)';
                specialEl.innerHTML = `<span class="avatar">${specialComment.a}</span><p>${specialComment.c}</p>`;
                overlay.appendChild(specialEl);
            }, delay + 1000);
        }

        // --- GIAI ƒêO·∫†N 3: C√ÇU H·ªéI V√Ä K·ª∂ NI·ªÜM ---
        getEl('next2').onclick = () => { updateEnergy(-15); fadeTransition('tram1', '', () => showModal('question-pop')); };
        
        // C·∫¢I TI·∫æN 3: Th√™m popup ph·∫£n h·ªìi khi ch·ªçn "c√≥a"
        getEl('coa').onclick = () => closeModal('question-pop', () => showModal('coa-response-pop'));
        getEl('continue-to-tram2').onclick = () => closeModal('coa-response-pop', () => fadeTransition('', 'tram2'));


        // --- GIAI ƒêO·∫†N 4: GAME ---
        function initGame() {
            cleanupGame();
            getEl('game-section').classList.remove('hidden');
            game = getEl('game-canvas'); ctx = game.getContext('2d');
            const rect = game.getBoundingClientRect();
            game.width = rect.width; game.height = rect.height;
            player = { x: game.width / 2, y: game.height - 40, size: 20, emoji: 'üòá' };
            items = []; score = 0; gamePhase = 'normal';
            state.assistantAvailable = false; state.assistantUsed = false;
            getEl('score-display').textContent = score;
            getEl('open-gift').classList.add('hidden'); getEl('summon-assistant-btn').classList.add('hidden');
            
            // C·∫¢I TI·∫æN 4: Th√™m ƒëi·ªÅu khi·ªÉn b·∫±ng c·∫£m ·ª©ng
            const movePlayer = (clientX) => {
                const currentRect = game.getBoundingClientRect();
                player.x = clientX - currentRect.left;
            };
            game.onmousemove = e => movePlayer(e.clientX);
            game.ontouchmove = e => { e.preventDefault(); movePlayer(e.touches[0].clientX); };
            
            spawnInterval = setInterval(spawnItem, 500);
            gameLoop = requestAnimationFrame(updateGame);
        }

        function spawnItem() {
            const itemTypes = { good: [{ emoji: 'üç¶', points: 5, size: 20 }, { emoji: 'üç∞', points: 5, size: 20 }, { emoji: 'üéÇ', points: 10, size: 25 }], bad: [{ emoji: 'üí£', points: -3, size: 20 }] };
            let type;
            // C·∫¢I TI·∫æN 4: Th√™m ch·∫ø ƒë·ªô b√£o bom
            if (gamePhase === 'bombardment' || (gamePhase === 'impossible' && !state.assistantUsed)) {
                type = itemTypes.bad[0];
            } else {
                const choice = Math.random() > 0.4 ? 'good' : 'bad';
                type = itemTypes[choice][Math.floor(Math.random() * itemTypes[choice].length)];
            }
            items.push({ x: Math.random() * game.width, y: -30, ...type, speed: Math.random() * 2 + 2 });
        }
        
        function updateGame() {
            // ... (Ph·∫ßn v·∫Ω v√† x·ª≠ l√Ω va ch·∫°m kh√¥ng ƒë·ªïi)
            score = Math.max(0, score); getEl('score-display').textContent = score;

            // C·∫¢I TI·∫æN 4: K√≠ch ho·∫°t ch·∫ø ƒë·ªô b√£o bom
            if (score >= 80 && !state.assistantUsed) {
                gamePhase = 'bombardment';
            } else if (score < 50) {
                gamePhase = 'normal';
            }

            if (gamePhase === 'bombardment' && !state.assistantAvailable && !state.assistantUsed) {
                state.assistantAvailable = true; showModal('assistant-needed-pop'); getEl('summon-assistant-btn').classList.remove('hidden');
            }
            if (score >= config.gameWinScore) { getEl('open-gift').classList.remove('hidden'); getEl('summon-assistant-btn').classList.add('hidden'); cleanupGame(); return; }
            gameLoop = requestAnimationFrame(updateGame);
        }
        
        // --- GIAI ƒêO·∫†N 5: KHO B√ÅU ---
        getEl('submit-pass2').onclick = () => {
            if (getEl('pass-input2').value.trim().toLowerCase() === config.password2.trim().toLowerCase()) {
                closeModal('phase3-pass-pop', () => { 
                    fadeTransition('', 'phase3', () => { 
                        const chest = getEl('treasure').querySelector('.chest'); 
                        chest.classList.add('open');
                        
                        // C·∫¢I TI·∫æN 5: Th√™m ph√°o hoa v√† lu·ªìng popup m·ªõi
                        confetti({ particleCount: 200, spread: 120, origin: { y: 0.6 } });
                        
                        setTimeout(() => {
                           getEl('phase3').classList.add('hidden'); // ·∫®n r∆∞∆°ng ƒëi
                           showModal('reward1-pop'); // Hi·ªán popup qu√† 1
                        }, 1500);
                    }); 
                });
            } else { alert('M·∫≠t kh·∫©u sai b√©t! H·ªèi l·∫°i ƒëi hehe'); }
        };

        // --- KH·ªûI ƒê·ªòNG V√Ä C√ÅC H√ÄM KH√ÅC (ƒê√£ r√∫t g·ªçn cho d·ªÖ nh√¨n) ---
        window.onload = () => { 
            // T·∫•t c·∫£ c√°c h√†m v√† s·ª± ki·ªán onclick kh√°c ƒë∆∞·ª£c gi·ªØ nguy√™n
            // ... (setupLockScreen, unlock, startWelcome, v.v...)
        };
    </script>
</body>
</html>
